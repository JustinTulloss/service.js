<!DOCTYPE html>

<html>
<head>
  <title>service.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="README.html">
                README.md
              </a>
            
              
              <a class="source" href="service.html">
                service.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>service.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Q)</span> {</span>
<span class="hljs-pi">  'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Check for dependencies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Object</span>.create) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"An Object.create polyfill is required to use Services"</span>);
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> Q === <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"The Q promises library is required to use Services"</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>A map of service names to implementations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> serviceProtos = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>This is actually not instances, but a map of names to promises
that produce instances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> servicePromises = {};
  <span class="hljs-keyword">var</span> doNothing = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="services">Services</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><code>Services</code> is the namespace for the services library. It contains
functions for registering service implementations and starting/stopping
services.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> Services = {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Registers a service implementation. Takes the name of the service and
the implementation. The implementation should extend <code>Services.Service</code>.
Returns the priority of this implementation (aka the number of
implementations available).</p>
<h4 id="example">Example</h4>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> DefaultImplementation = <span class="hljs-built_in">Object</span>.create(Services.Service);
Services.register(<span class="hljs-string">'MyService'</span>, DefaultImplementation);
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    register: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, service)</span> {</span>
      <span class="hljs-keyword">if</span> (serviceProtos[name]) {
        serviceProtos[name].push(service);
      } <span class="hljs-keyword">else</span> {
        serviceProtos[name] = [service];
      }
      <span class="hljs-keyword">return</span> serviceProtos[name].length;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Unregisters a particular service. Can also unregister all of a particular
serviceâ€™s implementations if not passed a particular service.</p>
<p>Returns the number of remaining implementations.</p>
<h4 id="example">Example</h4>
<pre><code class="lang-js"><span class="hljs-comment">// Unregisters one implementation of the service called `service`</span>
Services.unregister(<span class="hljs-string">'MyService'</span>, service);

<span class="hljs-comment">// Unregisters all services implementing MyService</span>
Services.unregister(<span class="hljs-string">'MyService'</span>);
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    unregister: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, service)</span> {</span>
      <span class="hljs-keyword">if</span> (servicePromises[name]) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot unregister a service that is starting or started"</span>);
      }
      <span class="hljs-keyword">var</span> serviceList = serviceProtos[name];
      <span class="hljs-keyword">if</span> (service) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; serviceList.length; i++) {
          <span class="hljs-keyword">if</span> (serviceList[i] === service) {
            serviceList.splice(i, <span class="hljs-number">1</span>);
          }
        }
        <span class="hljs-keyword">return</span> serviceList.length;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">delete</span> serviceProtos[name];
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Starts all the services or a subset of services.</p>
<p>For each service specified, this function will walk through the list of
registered services and attempt to start them if they report that they
are usable. If an implementation reports that it is not usable, the
function will attempt to start the next registered service or will fail
to start the service at all.</p>
<p>Returns a promise that is resolved when the services have started or
failed to start. The result of the returned promise is a list of
promise snapshots that indicate which services succeeded and
which failed.</p>
<p>Calls the <code>onStart</code> delegate for the first usable implementation
of a service. The <code>onStart</code> delegate can return a promise and <code>start</code>
will not resolve its promise until all promises returned are resolved.</p>
<h4 id="example">Example</h4>
<pre><code class="lang-js"><span class="hljs-comment">// Let's say that MyService succeeds and AnotherService fails...</span>
Services.start(<span class="hljs-string">'MyService'</span>, <span class="hljs-string">'AnotherService'</span>)
  .spread(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(myServiceP, anotherServiceP)</span> {</span>
    <span class="hljs-comment">// =&gt; fullfilled rejected</span>
    console.log(myServiceP.state, anotherServiceP.state)
    <span class="hljs-comment">// =&gt; &lt;MyService instance&gt; &lt;Error object&gt;</span>
    console.log(myServiceP.value, anotherServiceP.reaston)
  });

<span class="hljs-comment">// You can also call the function without arguments.</span>
Services.start(); <span class="hljs-comment">// Attempts to start all registered services.</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    start: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> serviceNames = <span class="hljs-built_in">arguments</span>.length ? <span class="hljs-built_in">arguments</span> : <span class="hljs-built_in">Object</span>.keys(serviceProtos);
      <span class="hljs-keyword">var</span> promises = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; serviceNames.length; i++) {
        (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>We copy the list so that modifications to the implementation list
donâ€™t get started if theyâ€™re registered after start is called.
All this code would be cleaner with persistent data structures.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> serviceName = serviceNames[i];
          <span class="hljs-keyword">var</span> serviceList = serviceProtos[serviceName].slice(<span class="hljs-number">0</span>);
          <span class="hljs-keyword">if</span> (servicePromises[serviceName]) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot start a service that's already started: "</span> + serviceName);
          }
          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attemptToStart</span><span class="hljs-params">(j)</span> {</span>
            <span class="hljs-keyword">var</span> instance = <span class="hljs-built_in">Object</span>.create(serviceList[j]);
            instance.onInitialize();
            <span class="hljs-keyword">var</span> isUsable = Q(instance.isUsable());
            <span class="hljs-keyword">var</span> startPromise = isUsable.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(usable)</span> {</span>
              <span class="hljs-keyword">if</span> (usable) {
                <span class="hljs-keyword">var</span> startPromise = instance.onStart() || Q(instance);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Guarantee that the final promise always resolves to the
started instance of the service.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                startPromise = startPromise.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                  <span class="hljs-keyword">return</span> instance;
                }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(reason)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>If we did not successfully start, delete the start promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  <span class="hljs-keyword">delete</span> servicePromises[serviceName];
                  <span class="hljs-keyword">throw</span> reason;
                });
                servicePromises[serviceName] = startPromise;
                <span class="hljs-keyword">return</span> startPromise;
              } <span class="hljs-keyword">else</span> {
                j++;
                <span class="hljs-keyword">if</span> (j &lt; serviceList.length) {
                  <span class="hljs-keyword">return</span> attemptToStart(j);
                } <span class="hljs-keyword">else</span> {
                  <span class="hljs-keyword">delete</span> servicePromises[serviceName];
                  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"No usable implementations of "</span> + serviceName);
                }
              }
            });
            servicePromises[serviceName] = startPromise;
            <span class="hljs-keyword">return</span> startPromise;
          }
          promises.push(attemptToStart(<span class="hljs-number">0</span>));
        }).call(<span class="hljs-keyword">this</span>);
      }
      <span class="hljs-keyword">return</span> Q.allSettled(promises);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Stops running services. Takes a variable number of service names as
arguments or stops all services if no arguments are passed.</p>
<p>Waits until all services that are being started are finished starting
and then calls the <code>onStop</code> delegate of each running instance. Does
not care what the <code>onStop</code> delegate does.</p>
<p>This function will not fail if itâ€™s called twice or if a service thatâ€™s
requested to be stopped is not running.</p>
<h4 id="example">Example</h4>
<pre><code class="lang-js">Services.stop(); <span class="hljs-comment">// Stops everything</span>
Services.stop(<span class="hljs-string">'MyService'</span>); <span class="hljs-comment">// Stops MyService if it's running.</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    stop: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> name;
      <span class="hljs-keyword">var</span> serviceNames = <span class="hljs-built_in">arguments</span>.length ? <span class="hljs-built_in">arguments</span> : <span class="hljs-built_in">Object</span>.keys(servicePromises);
      <span class="hljs-keyword">var</span> promises = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; serviceNames.length; i++) {
        (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
          <span class="hljs-keyword">if</span> (!servicePromises[name]) { <span class="hljs-keyword">return</span>; }
          promises.push(servicePromises[name].done(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(instance)</span> {</span>
            instance.onStop();
            <span class="hljs-keyword">delete</span> servicePromises[name];
          }));
        }).call(<span class="hljs-keyword">this</span>, serviceNames[i]);
      }
      <span class="hljs-keyword">return</span> Q.all(promises);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Indicates that a set of services is ready to be used.</p>
<p>This function should be used to declare that a bit of code depends on
services being ready to be used. As such it will fail if any of the
services asked for have failed to start.</p>
<p>Returns a promise that resolves to a list of the services requested, or
is rejected if any of the services havenâ€™t been started or failed to
start.</p>
<h4 id="example">Example</h4>
<pre><code class="lang-js">Services.ready(<span class="hljs-string">'MyService'</span>, <span class="hljs-string">'AnotherService'</span>)
  .spread(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(myService, anotherService)</span> {</span>
    myService.doThings();
    anotherService.doOtherThings();
  }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Couldn't do the things I wanted to do :("</span>);
  });
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ready: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> promises = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
        <span class="hljs-keyword">var</span> name = <span class="hljs-built_in">arguments</span>[i];
        <span class="hljs-keyword">if</span> (!servicePromises[name]) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(name + <span class="hljs-string">" was not started or failed to start"</span>);
        }
        promises.push(servicePromises[name]);
      }
      <span class="hljs-keyword">return</span> Q.all(promises);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>A function that allows you to inspect the current state of the various
running services. It returns an object with two properties: <code>registered</code>
and <code>running</code>.</p>
<p>This is useful information to contain in error reporting.</p>
<p><code>registered</code> is an object with the registered service
names as its properties and the number of implementations registered as
the values.</p>
<p><code>running</code> returns an object with the started or starting service names
as its properties and a state snapshot as its value. The state snapshot
contains a <code>state</code> property indicating whether the service has started
yet or not and, if it has, the implementation thatâ€™s running.</p>
<h4 id="example">Example</h4>
<pre><code class="lang-javascript">{
   registered: {
     MyService: <span class="hljs-number">1</span>,
     AnotherService: <span class="hljs-number">2</span>,
     UnusedService: <span class="hljs-number">1</span>
   },
   running: {
     MyService: { state: <span class="hljs-string">"pending"</span> },
     AnotherService: {
       state: <span class="hljs-string">"running"</span>,
       value: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">the</span> <span class="hljs-attribute">instance</span> <span class="hljs-attribute">of</span> <span class="hljs-attribute">the</span> <span class="hljs-attribute">running</span> <span class="hljs-attribute">service</span>&gt;</span>
     }
   }
}</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    status: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> i, name;
      <span class="hljs-keyword">var</span> registeredNames = <span class="hljs-built_in">Object</span>.keys(serviceProtos);
      <span class="hljs-keyword">var</span> registered = {};
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; registeredNames.length; i++) {
        name = registeredNames[i];
        registered[name] = serviceProtos[name].length;
      }
      <span class="hljs-keyword">var</span> running = {};
      <span class="hljs-keyword">var</span> runningNames = <span class="hljs-built_in">Object</span>.keys(servicePromises);
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; runningNames.length; i++) {
        name = runningNames[i];
        running[name] = servicePromises[name].inspect();
      }
      <span class="hljs-keyword">return</span> {
        registered: registered,
        running: running
      };
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="services-service">Services.Service</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>A base prototype for a service. All other services should extend this one
or implement every method that it implements.</p>
<h4 id="example">Example</h4>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> MyService = <span class="hljs-built_in">Object</span>.create(Services.Service);
<span class="hljs-comment">// This uses underscore.js, which is not required.</span>
_.extend(MyService, {
  onStart: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">// Do everything needed to start running.</span>
  },
  myMethod: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">//...</span>
  }
});
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Service: {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Called when object is first created. Must be synchronous.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      onInitialize: doNothing,</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Called when service is being started. Can return a promise if startup
involves an asynchronous action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      onStart: doNothing,</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Called when the service is being stopped.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      onStop: doNothing,</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Called to determine whether this implementation can be used in the
current environment. Can return a promise if figuring out the answer
is asynchronous. This should either return a truthy or falsy value
or return a promise that will resolve to a truthy or falsy value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      isUsable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }
  };
  <span class="hljs-keyword">this</span>.Services = Services;
  <span class="hljs-keyword">return</span> Services;
}).call(<span class="hljs-keyword">this</span>, Q);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
